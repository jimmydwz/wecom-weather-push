name: Weather to WeCom

on:
  schedule:
   #åœæ­¢å®šæ—¶ä»»åŠ¡ - cron: "0 1 * * *" # 09:00 åŒ—äº¬æ—¶é—´ï¼ˆUTC 01:00ï¼‰
  workflow_dispatch:

jobs:
  push:
    runs-on: ubuntu-latest
    env:
      WECOM_WEBHOOK: ${{ secrets.WECOM_WEBHOOK }}
    steps:
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Fetch weather and push
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${WECOM_WEBHOOK:-}" ]; then
            echo "Missing secret WECOM_WEBHOOK"
            exit 2
          fi

          # weathercode -> ä¸­æ–‡æè¿°
          weather_desc () {
            case "$1" in
              0) echo "æ™´æœ—" ;;
              1) echo "å¤§éƒ¨æ™´æœ—" ;;
              2) echo "å¤šäº‘" ;;
              3) echo "é˜´å¤©" ;;
              45|48) echo "æœ‰é›¾" ;;
              51) echo "å°æ¯›æ¯›é›¨" ;;
              53) echo "ä¸­ç­‰æ¯›æ¯›é›¨" ;;
              55) echo "å¤§æ¯›æ¯›é›¨" ;;
              56|57) echo "å†»æ¯›æ¯›é›¨" ;;
              61) echo "å°é›¨" ;;
              63) echo "ä¸­é›¨" ;;
              65) echo "å¤§é›¨" ;;
              66|67) echo "å†»é›¨" ;;
              71) echo "å°é›ª" ;;
              73) echo "ä¸­é›ª" ;;
              75) echo "å¤§é›ª" ;;
              77) echo "é›ªç²’" ;;
              80) echo "å°é˜µé›¨" ;;
              81) echo "ä¸­é˜µé›¨" ;;
              82) echo "å¼ºé˜µé›¨" ;;
              85) echo "å°é˜µé›ª" ;;
              86) echo "å¤§é˜µé›ª" ;;
              95) echo "é›·æš´" ;;
              96|99) echo "é›·æš´ä¼´å†°é›¹" ;;
              *) echo "æœªçŸ¥å¤©æ°”" ;;
            esac
          }

          fetch_two_days () {
            # args: city_label lat lon timezone
            local label="$1"
            local lat="$2"
            local lon="$3"
            local tz="$4"

            local json
            json="$(curl -fsS "https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,weathercode&timezone=${tz}&forecast_days=2")"

            local d0 d1 tmax0 tmin0 pop0 code0 tmax1 tmin1 pop1 code1
            d0="$(jq -r '.daily.time[0] // empty' <<<"$json")"
            d1="$(jq -r '.daily.time[1] // empty' <<<"$json")"
            tmax0="$(jq -r '.daily.temperature_2m_max[0] // empty' <<<"$json")"
            tmin0="$(jq -r '.daily.temperature_2m_min[0] // empty' <<<"$json")"
            pop0="$(jq -r '.daily.precipitation_probability_max[0] // 0' <<<"$json")"
            code0="$(jq -r '.daily.weathercode[0] // empty' <<<"$json")"
            tmax1="$(jq -r '.daily.temperature_2m_max[1] // empty' <<<"$json")"
            tmin1="$(jq -r '.daily.temperature_2m_min[1] // empty' <<<"$json")"
            pop1="$(jq -r '.daily.precipitation_probability_max[1] // 0' <<<"$json")"
            code1="$(jq -r '.daily.weathercode[1] // empty' <<<"$json")"

            if [ -z "$d0" ] || [ -z "$d1" ] || [ -z "$tmax0" ] || [ -z "$tmin0" ] || [ -z "$tmax1" ] || [ -z "$tmin1" ] || [ -z "$code0" ] || [ -z "$code1" ]; then
              echo "Data missing for ${label}"
              echo "$json"
              exit 2
            fi

            local desc0 desc1
            desc0="$(weather_desc "$code0")"
            desc1="$(weather_desc "$code1")"

            # è¾“å‡ºï¼šlabel|d0|desc0|tmax0|tmin0|pop0|d1|desc1|tmax1|tmin1|pop1
            echo "${label}|${d0}|${desc0}|${tmax0}|${tmin0}|${pop0}|${d1}|${desc1}|${tmax1}|${tmin1}|${pop1}"
          }

          # çº½çº¦ / æ´›æ‰çŸ¶
          ny="$(fetch_two_days "çº½çº¦ New York" "40.7128" "-74.0060" "America/New_York")"
          la="$(fetch_two_days "æ´›æ‰çŸ¶ Los Angeles" "34.0522" "-118.2437" "America/Los_Angeles")"

          # å¤šä¼¦å¤š / å¡å°”åŠ é‡Œ
          tor="$(fetch_two_days "å¤šä¼¦å¤š Toronto" "43.6532" "-79.3832" "America/Toronto")"
          cal="$(fetch_two_days "å¡å°”åŠ é‡Œ Calgary" "51.0447" "-114.0719" "America/Edmonton")"

          IFS='|' read -r ny_name ny_d0 ny_desc0 ny_tmax0 ny_tmin0 ny_pop0 ny_d1 ny_desc1 ny_tmax1 ny_tmin1 ny_pop1 <<< "$ny"
          IFS='|' read -r la_name la_d0 la_desc0 la_tmax0 la_tmin0 la_pop0 la_d1 la_desc1 la_tmax1 la_tmin1 la_pop1 <<< "$la"
          IFS='|' read -r tor_name tor_d0 tor_desc0 tor_tmax0 tor_tmin0 tor_pop0 tor_d1 tor_desc1 tor_tmax1 tor_tmin1 tor_pop1 <<< "$tor"
          IFS='|' read -r cal_name cal_d0 cal_desc0 cal_tmax0 cal_tmin0 cal_pop0 cal_d1 cal_desc1 cal_tmax1 cal_tmin1 cal_pop1 <<< "$cal"

          content="$(printf "### ğŸŒ¤ï¸ å¤©æ°”é¢„æŠ¥ï¼ˆä»Šå¤©/æ˜å¤©ï¼‰\n\n**%s**\n- ä»Šå¤©ï¼ˆ%sï¼‰ï¼š%sï¼›%sÂ°C / %sÂ°Cï¼›é™æ°´ %s%%\n- æ˜å¤©ï¼ˆ%sï¼‰ï¼š%sï¼›%sÂ°C / %sÂ°Cï¼›é™æ°´ %s%%\n\n**%s**\n- ä»Šå¤©ï¼ˆ%sï¼‰ï¼š%sï¼›%sÂ°C / %sÂ°Cï¼›é™æ°´ %s%%\n- æ˜å¤©ï¼ˆ%sï¼‰ï¼š%sï¼›%sÂ°C / %sÂ°Cï¼›é™æ°´ %s%%\n\n**%s**\n- ä»Šå¤©ï¼ˆ%sï¼‰ï¼š%sï¼›%sÂ°C / %sÂ°Cï¼›é™æ°´ %s%%\n- æ˜å¤©ï¼ˆ%sï¼‰ï¼š%sï¼›%sÂ°C / %sÂ°Cï¼›é™æ°´ %s%%\n\n**%s**\n- ä»Šå¤©ï¼ˆ%sï¼‰ï¼š%sï¼›%sÂ°C / %sÂ°Cï¼›é™æ°´ %s%%\n- æ˜å¤©ï¼ˆ%sï¼‰ï¼š%sï¼›%sÂ°C / %sÂ°Cï¼›é™æ°´ %s%%\n" \
            "$ny_name" "$ny_d0" "$ny_desc0" "$ny_tmax0" "$ny_tmin0" "$ny_pop0" "$ny_d1" "$ny_desc1" "$ny_tmax1" "$ny_tmin1" "$ny_pop1" \
            "$la_name" "$la_d0" "$la_desc0" "$la_tmax0" "$la_tmin0" "$la_pop0" "$la_d1" "$la_desc1" "$la_tmax1" "$la_tmin1" "$la_pop1" \
            "$tor_name" "$tor_d0" "$tor_desc0" "$tor_tmax0" "$tor_tmin0" "$tor_pop0" "$tor_d1" "$tor_desc1" "$tor_tmax1" "$tor_tmin1" "$tor_pop1" \
            "$cal_name" "$cal_d0" "$cal_desc0" "$cal_tmax0" "$cal_tmin0" "$cal_pop0" "$cal_d1" "$cal_desc1" "$cal_tmax1" "$cal_tmin1" "$cal_pop1")"

          payload="$(jq -n --arg c "$content" '{msgtype:"markdown", markdown:{content:$c}}')"
          resp="$(curl -fsS -X POST "$WECOM_WEBHOOK" -H "Content-Type: application/json" -d "$payload")"
          echo "WeCom response: $resp"

          errcode="$(jq -r '.errcode // -1' <<<"$resp")"
          if [ "$errcode" != "0" ]; then
            echo "Push failed"
            exit 2
          fi
